<!DOCTYPE html>
<html>
<head>
    <title>RDAP Conformance Tool</title>
    <!-- Include Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
   
</head>
<body class="bg-gray-100 h-screen antialiased leading-none">
  <div id="app" class="container mx-auto px-4 pt-10">
    <h1 class="text-4xl mb-4 text-blue-500">{{ message }}</h1>
    <p class="text-lg mb-8">Welcome to RDAP Conformance</p>
   
    <form @submit.prevent="submitForm" class="mb-8">
      <label for="url" class="block mb-2">URL:</label>
      <input type="text" id="url" v-model="url" class="border p-4 h-12 w-full">
      <br>
      <!-- <label for="switch" class="block mb-2">Switch to /check:</label>
      <input type="checkbox" id="switch" v-model="useCheckEndpoint" class="mb-4"> -->
      <input type="submit" value="Submit" :disabled="isLoading" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-6 block">
      <input type="reset" value="Clear"  @click="clearResponse" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mt-6 block">
      <span v-if="isLoading" class="block mt-4">Loading...</span>
  </form>
    <p>
      <pre><code class="json" v-html="highlightedServerResponse"></code></pre>
      <!-- <pre class="text-xs" style="white-space: pre-wrap; word-wrap: break-word; max-width: 100%; background-color: white;">{{ formattedServerResponse }}</pre> -->
    </p>
  </div>
</body>

  <script>
      new Vue({
          el: '#app',
          data: {
              message: 'RDAP Conformance Tool',
              url: '',
              serverResponse: '',
              isLoading: false,
              useCheckEndpoint: true 
          },
          mounted() {
            hljs.highlightAll();
          },
          watch: {
            formattedServerResponse() {
                this.$nextTick(function () {
                    this.highlightCode();
                })
            }
          },
          computed: {
            formattedServerResponse: function() {
                try {
                    let parsedResponse = JSON.parse(this.serverResponse);
                    if (parsedResponse.data) {
                      console.log('yeah, got it: ' + parsedResponse.data);
                      // return JSON.stringify(parsedResponse.data, null, 2)
                      return parsedResponse.data;
                        // let innerData = JSON.parse(parsedResponse.data);
                        // return innerData.value;
                    }
                    console.log('nope, not got it: ', parsedResponse);
                    return JSON.stringify(parsedResponse, null, 2); // stringify with indentation
                } catch(e) {
                    // If it's not JSON, return as is
                    // console.log('error: ', e);
                    return this.serverResponse;
                }
            },
            highlightedServerResponse: function() {
                if (this.formattedServerResponse) {
                    // Highlight the code and return it as a string
                    return hljs.highlight('json', this.formattedServerResponse).value;
                } else {
                    return 'Formatting Failure';
                }
            }
          },
          methods: {
            highlightCode() {
                hljs.highlightAll();
            },
            clearResponse: function() { 
                this.serverResponse = '';
            },
            submitForm() {
              this.isLoading = true; // Set loading state to true when form is submitted
              let endpoint = this.useCheckEndpoint ? '/check' : '/old';
              fetch(endpoint, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: `url=${encodeURIComponent(this.url)}`,
              })
              .then(response => response.json())
              .then(data => {
                  // Handle the response data
                  console.log(data);
                  this.serverResponse = JSON.stringify(data); // Update the serverResponse property with the response data
                  this.isLoading = false; // Set loading state to false when response is received
              })
              .catch(error => {
                  // Handle the error
                  console.error('Error:', error);
                  this.serverResponse = 'Error: ' + error; // Update the serverResponse property with the error
                  this.isLoading = false; // Set loading state to false when error is received
              });
            }
          }
      });
  </script>
</body>
</html>